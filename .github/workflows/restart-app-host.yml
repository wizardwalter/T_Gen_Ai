name: Restart App Host

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  restart:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
          role-session-name: gha-restart

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0
          terraform_wrapper: false

      - name: Terraform Init (outputs only)
        working-directory: terraform
        run: >
          terraform init
          -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}"
          -backend-config="key=${{ secrets.TF_STATE_KEY }}"
          -backend-config="region=${{ env.AWS_REGION }}"
          -backend-config="dynamodb_table=${{ secrets.TF_STATE_LOCK_TABLE }}"

      - name: Fetch app host output
        working-directory: terraform
        run: |
          echo "APP_HOST_INSTANCE_ID=$(terraform output -raw app_host_instance_id)" >> $GITHUB_ENV

      - name: Reboot app host
        run: |
          aws ec2 reboot-instances --instance-ids "$APP_HOST_INSTANCE_ID" --region $AWS_REGION
          echo "Waiting for instance $APP_HOST_INSTANCE_ID to pass status checks..."
          aws ec2 wait instance-status-ok --instance-ids "$APP_HOST_INSTANCE_ID" --region $AWS_REGION
          echo "Waiting for SSM ping..."
          for i in {1..30}; do
            PING=$(aws ssm describe-instance-information \
              --filters Key=InstanceIds,Values="$APP_HOST_INSTANCE_ID" \
              --region "$AWS_REGION" \
              --query 'InstanceInformationList[0].PingStatus' --output text || true)
            if [ "$PING" = "Online" ]; then
              echo "SSM Online"
              exit 0
            fi
            sleep 10
          done
          echo "SSM not online after wait"
          exit 1

      - name: Verify containers
        run: |
          CMD_ID=$(aws ssm send-command \
            --instance-ids "$APP_HOST_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters commands='["docker ps"]' \
            --region "$AWS_REGION" \
            --query 'Command.CommandId' --output text)
          sleep 5
          aws ssm get-command-invocation \
            --command-id "$CMD_ID" \
            --instance-id "$APP_HOST_INSTANCE_ID" \
            --region "$AWS_REGION" \
            --query '{status:Status,stdOut:StandardOutputContent,stdErr:StandardErrorContent}'
