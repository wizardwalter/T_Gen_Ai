name: Deploy

on:
  # push:
  #   branches: [main] Not needed yet
  workflow_dispatch:
    
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      TF_VAR_api_domain_name: ${{ secrets.API_DOMAIN_NAME }}
      TF_VAR_ui_domain_name: ${{ secrets.UI_DOMAIN_NAME }}
      TF_VAR_root_domain_name: ${{ secrets.ROOT_DOMAIN_NAME }}
      TF_VAR_apex_redirect_target: ${{ secrets.APEX_REDIRECT_TARGET }}
      TF_VAR_hosted_zone_id: ${{ secrets.HOSTED_ZONE_ID }}
      TF_VAR_nextauth_url: ${{ secrets.NEXTAUTH_URL }}
      TF_VAR_next_public_api_base: ${{ secrets.NEXT_PUBLIC_API_BASE }}
      TF_VAR_api_base: ${{ secrets.API_BASE }}
      TF_VAR_api_shared_secret: ${{ secrets.API_SHARED_SECRET }}
      TF_VAR_next_public_icon_base: ${{ secrets.NEXT_PUBLIC_ICON_BASE }}
      TF_VAR_google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}
      TF_VAR_google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      TF_VAR_nextauth_secret: ${{ secrets.NEXTAUTH_SECRET }}
      TF_VAR_oauth_github_client_id: ${{ secrets.OAUTH_GITHUB_CLIENT_ID }}
      TF_VAR_oauth_github_client_secret: ${{ secrets.OAUTH_GITHUB_CLIENT_SECRET }}
      TF_VAR_db_master_username: ${{ secrets.DB_MASTER_USERNAME }}
      TF_VAR_db_master_password: ${{ secrets.DB_MASTER_PASSWORD }}
      TF_VAR_db_name: ${{ secrets.DB_NAME }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
      NEXT_PUBLIC_API_BASE: ${{ secrets.NEXT_PUBLIC_API_BASE }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      OAUTH_GITHUB_CLIENT_ID: ${{ secrets.OAUTH_GITHUB_CLIENT_ID }}
      OAUTH_GITHUB_CLIENT_SECRET: ${{ secrets.OAUTH_GITHUB_CLIENT_SECRET }}
      NEXT_PUBLIC_ICON_BASE: ${{ secrets.NEXT_PUBLIC_ICON_BASE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
          role-session-name: gha-deploy
          role-duration-seconds: 7200

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        run: >
          terraform init
          -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}"
          -backend-config="key=${{ secrets.TF_STATE_KEY }}"
          -backend-config="region=${{ env.AWS_REGION }}"
          -backend-config="dynamodb_table=${{ secrets.TF_STATE_LOCK_TABLE }}"

      - name: Compute API repo
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "API_REPO=${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/aidevops-api" >> $GITHUB_ENV
          echo "UI_REPO=${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/aidevops-ui" >> $GITHUB_ENV
          IMAGE_TAG="${GITHUB_SHA::7}"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "TF_VAR_api_image=${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/aidevops-api:${IMAGE_TAG}" >> $GITHUB_ENV
          echo "TF_VAR_ui_image=${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/aidevops-ui:${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Terraform apply (create ECR first)
        working-directory: terraform
        run: terraform apply -auto-approve -target=aws_ecr_repository.api -target=aws_ecr_repository.ui

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $API_REPO
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $UI_REPO

      - name: Build and push API image
        run: |
          docker build -t $API_REPO:${IMAGE_TAG} api
          docker push $API_REPO:${IMAGE_TAG}

      - name: Build and push UI image
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_API_BASE=${NEXT_PUBLIC_API_BASE} \
            --build-arg NEXTAUTH_URL=${NEXTAUTH_URL} \
            --build-arg NEXT_PUBLIC_ICON_BASE=${NEXT_PUBLIC_ICON_BASE} \
            -t $UI_REPO:${IMAGE_TAG} ui
          docker push $UI_REPO:${IMAGE_TAG}

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve
